(function(e,t){function n(n){var r,o,i,a,s,u,f,c,d,l,p,h,v,y,g,m,x,b,w,E,k,C,L,T,R,M,A,q,O,D,X,N,S,H,_,j,B,F;x=!1,q=function(e){var t,n;x||g();for(t in e)n=e[t],C("adding slave: "+t),q[t]=n},p={},h=function(e,t){var n;return p[e]?p[e]:(n=c.createElement("iframe"),n.id=n.name=v(),C("creating iframe "+n.id),n.src=""+e+t,n.setAttribute("style","display:none;"),c.body.appendChild(n),p[e]=n.contentWindow)},g=function(){var e,t,r;return x=!0,t=function(e,t){var n,r,o,i,a;return o=e[0],i=e[1],n=w(i,"Blob"),r=w(i,"File"),n||r?(a=new FileReader,a.onload=function(){return e[1]=null,r&&(e[2]=i.name),t(["XD_BLOB",e,this.result,i.type])},a.readAsArrayBuffer(i),1):0},e=function(e,n){var r;e.forEach(function(t,n){var r,o,i,a,s;if(o=t[0],i=t[1],w(i,"FileList"))for(e.splice(n,1),a=0,s=i.length;s>a;a++)r=i[a],e.splice(n,0,[o,r])}),r=0,e.forEach(function(o,i){r+=t(o,function(t){e[i]=t,0===--r&&n()})}),0===r&&n()},r=function(t,n){var r,o,i;return n.on("xhr-event",function(){return t.xhr.dispatchEvent.apply(null,arguments)}),n.on("xhr-upload-event",function(){return t.xhr.upload.dispatchEvent.apply(null,arguments)}),o=N(t),o.headers=t.headers,t.withCredentials&&(s.master&&(o.headers[s.master]=c.cookie),o.slaveCookie=s.slave),i=function(){return n.emit("request",o)},t.body&&(o.body=t.body,w(o.body,"FormData"))?(r=o.body.entries,o.body=["XD_FD",r],void e(r,i)):void i()},"addWithCredentials"in n||(n.addWithCredentials=!0),n.before(function(e,t){var n,o,i;return o=M(e.url),o&&o.origin!==f?q[o.origin]?(C("proxying request to slave: '"+o.origin+"'"),e.async===!1?(H("sync not supported"),t()):(n=h(o.origin,q[o.origin]),i=u(v(),n),i.on("response",function(e){return t(e),i.close()}),e.xhr.addEventListener("abort",function(){return i.emit("abort")}),void(i.ready?r(e,i):i.once("ready",function(){return r(e,i)})))):(o&&C("no slave matching: '"+o.origin+"'"),t()):t()})},b=!1,T=function(e){var t,n;b||m();for(t in e)n=e[t],C("adding master: "+t),T[t]=n},y=null,m=function(){return b=!0,C("handling incoming sockets..."),y=function(e,t){var r,o,i,a;"null"===e&&(e="*"),i=null;for(r in T){a=T[r];try{if(o=S(r),o.test(e)){i=S(a);break}}catch(s){}}return i?(t.once("request",function(e){var r,o,a,s,u,f,d,l,p,h,v;if(C("request: "+e.method+" "+e.url),f=M(e.url),!f||!i.test(f.path))return H("blocked request to path: '"+f.path+"' by regex: "+i),void t.close();l=new XMLHttpRequest,l.open(e.method,e.url),l.addEventListener("*",function(e){return t.emit("xhr-event",e.type,N(e))}),l.upload&&l.upload.addEventListener("*",function(e){return t.emit("xhr-upload-event",e.type,N(e))}),t.once("abort",function(){return l.abort()}),l.onreadystatechange=function(){var e;if(4===l.readyState){e={status:l.status,statusText:l.statusText,data:l.response,headers:n.headers(l.getAllResponseHeaders())};try{e.text=l.responseText}catch(r){}return t.emit("response",e)}},e.withCredentials&&(l.withCredentials=!0,e.slaveCookie&&(e.headers[e.slaveCookie]=c.cookie)),e.timeout&&(l.timeout=e.timeout),e.type&&(l.responseType=e.type),v=e.headers;for(u in v)d=v[u],l.setRequestHeader(u,d);if(e.body instanceof Array&&"XD_FD"===e.body[0]){for(s=new n.FormData,a=e.body[1],p=0,h=a.length;h>p;p++)r=a[p],"XD_BLOB"===r[0]&&4===r.length&&(o=new Blob([r[2]],{type:r[3]}),r=r[1],r[1]=o),s.append.apply(s,r);e.body=s}l.send(e.body||null)}),void C("slave listening for requests on socket: "+t.id)):void H("blocked request from: '"+e+"'")},e===e.parent?H("slaves must be in an iframe"):e.parent.postMessage("XDPING_"+o,"*")},i="XD_CHECK",D={},E=!0,u=function(e,t){var o,a,s,u,f,c;return f=!1,c=D[e]=n.EventEmitter(!0),c.id=e,c.once("close",function(){return c.destroy(),c.close()}),u=[],c.emit=function(){var t,n;t=O(arguments),n="string"==typeof t[1]?" -> "+t[1]:"",C("send socket: "+e+": "+t[0]+n),t.unshift(e),f?s(t):u.push(t)},s=function(e){E&&(e=JSON.stringify(e)),t.postMessage(e,"*")},c.close=function(){c.emit("close"),C("close socket: "+e),D[e]=null},c.once(i,function(t){for(E="string"==typeof t,f=c.ready=!0,c.emit("ready"),C("ready socket: "+e+" (emit #"+u.length+" pending)");u.length;)s(u.shift())}),a=0,o=function(n){return function(){t.postMessage([e,i,{}],"*"),f||(a++>=_.timeout/r?(H("Timeout waiting on iframe socket"),d.fire("timeout"),c.fire("abort")):setTimeout(o,r))}}(this),setTimeout(o),C("new socket: "+e),c},R=function(t){return c.addEventListener?e.addEventListener("message",t):e.attachEvent("onmessage",t)},X=function(){return R(function(e){var n,r,i,a;if(n=e.data,"string"==typeof n){if(/^XDPING(_(V\d+))?$/.test(n)&&RegExp.$2!==o)return H("your master is not compatible with your slave, check your xdomain.js version");if(/^xdomain-/.test(n))n=n.split(",");else if(E)try{n=JSON.parse(n)}catch(s){return}}if(n instanceof Array&&(i=n.shift(),/^xdomain-/.test(i)&&(a=D[i],null!==a))){if(a===t){if(!y)return;a=u(i,e.source),y(e.origin,a)}r="string"==typeof n[1]?" -> "+n[1]:"",C("receive socket: "+i+": "+n[0]+r),a.fire.apply(a,n)}})},"undefined"==typeof n&&(n=(this.exports||this).xhook),_=function(e){e&&(e.masters&&T(e.masters),e.slaves&&q(e.slaves))},_.masters=T,_.slaves=q,_.debug=!1,_.timeout=15e3,r=100,s=_.cookies={master:"Master-Cookie",slave:"Slave-Cookie"},c=e.document,k=e.location,f=_.origin=k.protocol+"//"+k.host,v=function(){return"xdomain-"+Math.round(Math.random()*Math.pow(2,32)).toString(16)},O=function(e,t){return Array.prototype.slice.call(e,t)},a=e.console||{},d=null,A=function(){d=n.EventEmitter(!0),_.on=d.on,_.off=d.off},n&&A(),L=function(e){return function(t){t="xdomain ("+f+"): "+t,d.fire(e,t),("log"!==e||_.debug)&&(e in _?_[e](t):e in a?a[e](t):"warn"===e&&alert(t))}},C=L("log"),H=L("warn"),F=["postMessage","JSON"];for(j=0,B=F.length;B>j;j++)if(l=F[j],!e[l])return void H("requires '"+l+"' and this browser does not support it");return w=function(t,n){return n in e?t instanceof e[n]:!1},o="V1",M=_.parseUrl=function(e){return/^((https?:)?\/\/[^\/\?]+)(\/.*)?/.test(e)?{origin:(RegExp.$2?"":k.protocol)+RegExp.$1,path:RegExp.$3}:(C("failed to parse absolute url: "+e),null)},S=function(e){var t;return e instanceof RegExp?e:(t=e.toString().replace(/\W/g,function(e){return"\\"+e}).replace(/\\\*/g,".*"),new RegExp("^"+t+"$"))},N=function(e){var t,n,r,o;t={};for(n in e)"returnValue"!==n&&(r=e[n],"function"!=(o=typeof r)&&"object"!==o&&(t[n]=r));return t},function(){var e,t,n,r,o,i,a,s,u,f,d;for(e={debug:function(e){return"string"==typeof e?_.debug="false"!==e:void 0},slave:function(e){var t,n;if(e&&(t=M(e)))return n={},n[t.origin]=t.path,q(n)},master:function(e){var t,n;if(e&&(n="*"===e?{origin:"*",path:"*"}:M(e)))return t={},t[n.origin]=n.path.replace(/^\//,"")?n.path:"*",T(t)}},f=c.getElementsByTagName("script"),i=0,s=f.length;s>i;i++)if(o=f[i],/xdomain/.test(o.src))for(d=["","data-"],a=0,u=d.length;u>a;a++){r=d[a];for(n in e)(t=e[n])(o.getAttribute(r+n))}}(),X(),A(),_}(function(e,t){function n(){var n,r,o,i,a,s,u,f,c,d,l,p,h,v,y,g,m,x,b,w,E,k,C,L,T,R=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};return x=e.document,r="before",n="after",l="readyState",d="addEventListener",c="removeEventListener",a="dispatchEvent",y="XMLHttpRequest",s="FormData",p=["load","loadend","loadstart"],o=["progress","abort","error","timeout"],E=parseInt((/msie (\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1]),isNaN(E)&&(E=parseInt((/trident\/.*; rv:(\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1])),(T=Array.prototype).indexOf||(T.indexOf=function(e){var t,n,r,o;for(t=r=0,o=this.length;o>r;t=++r)if(n=this[t],n===e)return t;return-1}),C=function(e,t){return Array.prototype.slice.call(e,t)},m=function(e){return"returnValue"===e||"totalSize"===e||"position"===e},w=function(e,t){var n,r;for(n in e)if(r=e[n],!m(n))try{t[n]=e[n]}catch(o){}return t},k=function(e,t,n){var r,o,i,s;for(o=function(e){return function(r){var o,i,s;o={};for(i in r)m(i)||(s=r[i],o[i]=s===t?n:s);return n[a](e,o)}},i=0,s=e.length;s>i;i++)r=e[i],n._has(r)&&(t["on"+r]=o(r))},b=function(e){var t;if(null!=x.createEventObject)return t=x.createEventObject(),t.type=e,t;try{return new Event(e)}catch(n){return{type:e}}},i=function(e){var n,r,o;return r={},o=function(e){return r[e]||[]},n={},n[d]=function(e,n,i){r[e]=o(e),r[e].indexOf(n)>=0||(i=i===t?r[e].length:i,r[e].splice(i,0,n))},n[c]=function(e,n){var i;return e===t?void(r={}):(n===t&&(r[e]=[]),i=o(e).indexOf(n),void(-1!==i&&o(e).splice(i,1)))},n[a]=function(){var r,i,a,s,u,f,c,d;for(r=C(arguments),i=r.shift(),e||(r[0]=w(r[0],b(i))),s=n["on"+i],s&&s.apply(t,r),d=o(i).concat(o("*")),a=f=0,c=d.length;c>f;a=++f)u=d[a],u.apply(t,r)},n._has=function(e){return!(!r[e]&&!n["on"+e])},e&&(n.listeners=function(e){return C(o(e))},n.on=n[d],n.off=n[c],n.fire=n[a],n.once=function(e,t){var r;return r=function(){return n.off(e,r),t.apply(null,arguments)},n.on(e,r)},n.destroy=function(){return r={}}),n},L=i(!0),L.EventEmitter=i,L[r]=function(e,t){if(e.length<1||e.length>2)throw"invalid hook";return L[d](r,e,t)},L[n]=function(e,t){if(e.length<2||e.length>3)throw"invalid hook";return L[d](n,e,t)},L.enable=function(){e[y]=v,u&&(e[s]=h)},L.disable=function(){e[y]=L[y],e[s]=u},g=L.headers=function(e,t){var n,r,o,i,a,s,u,f,c;switch(null==t&&(t={}),typeof e){case"object":r=[];for(o in e)a=e[o],i=o.toLowerCase(),r.push(""+i+":	"+a);return r.join("\n");case"string":for(r=e.split("\n"),u=0,f=r.length;f>u;u++)n=r[u],/([^:]+):\s*(.+)/.test(n)&&(i=null!=(c=RegExp.$1)?c.toLowerCase():void 0,s=RegExp.$2,null==t[i]&&(t[i]=s));return t}},u=e[s],h=function(e){var t;this.fd=e?new u(e):new u,this.form=e,t=[],Object.defineProperty(this,"entries",{get:function(){var n;return n=e?C(e.querySelectorAll("input,select")).filter(function(e){var t;return"checkbox"!==(t=e.type)&&"radio"!==t||e.checked}).map(function(e){return[e.name,"file"===e.type?e.files:e.value]}):[],n.concat(t)}}),this.append=function(e){return function(){var n;return n=C(arguments),t.push(n),e.fd.append.apply(e.fd,n)}}(this)},u&&(L[s]=u,e[s]=h),f=e[y],L[y]=f,v=function(){var e,t,s,u,f,c,v,m,x,b,C,T,M,A,q,O,D;return e=-1,D=new L[y],b={},M=null,c=void 0,A=void 0,C=void 0,x=function(){var t,n,r,o;if(C.status=M||D.status,M===e&&10>E||(C.statusText=D.statusText),M!==e){o=g(D.getAllResponseHeaders());for(t in o)r=o[t],C.headers[t]||(n=t.toLowerCase(),C.headers[n]=r)}},m=function(){D.responseType&&"text"!==D.responseType?"document"===D.responseType?(C.xml=D.responseXML,C.data=D.responseXML):C.data=D.response:(C.text=D.responseText,C.data=D.responseText),"responseURL"in D&&(C.finalUrl=D.responseURL)},O=function(){f.status=C.status,f.statusText=C.statusText},q=function(){"text"in C&&(f.responseText=C.text),"xml"in C&&(f.responseXML=C.xml),"data"in C&&(f.response=C.data),"finalUrl"in C&&(f.responseURL=C.finalUrl)},u=function(e){for(;e>t&&4>t;)f[l]=++t,1===t&&f[a]("loadstart",{}),2===t&&O(),4===t&&(O(),q()),f[a]("readystatechange",{}),4===t&&setTimeout(s,0)},s=function(){c||f[a]("load",{}),f[a]("loadend",{}),c&&(f[l]=0)},t=0,T=function(e){var t,r;return 4!==e?void u(e):(t=L.listeners(n),r=function(){var e;return t.length?(e=t.shift(),2===e.length?(e(b,C),r()):3===e.length&&b.async?e(b,C,r):r()):u(4)},void r())},f=b.xhr=i(),D.onreadystatechange=function(e){try{2===D[l]&&x()}catch(t){}4===D[l]&&(A=!1,x(),m()),T(D[l])},v=function(){c=!0},f[d]("error",v),f[d]("timeout",v),f[d]("abort",v),f[d]("progress",function(){3>t?T(3):f[a]("readystatechange",{})}),("withCredentials"in D||L.addWithCredentials)&&(f.withCredentials=!1),f.status=0,f.open=function(e,n,r,o,i){t=0,c=!1,A=!1,b.headers={},b.headerNames={},b.status=0,C={},C.headers={},b.method=e,b.url=n,b.async=r!==!1,b.user=o,b.pass=i,T(1)},f.send=function(e){var t,n,i,a,s,u,c,d;for(d=["type","timeout","withCredentials"],u=0,c=d.length;c>u;u++)n=d[u],i="type"===n?"responseType":n,i in f&&(b[n]=f[i]);b.body=e,s=function(){var e,t,r,a,s,u;for(k(o,D,f),f.upload&&k(o.concat(p),D.upload,f.upload),A=!0,D.open(b.method,b.url,b.async,b.user,b.pass),s=["type","timeout","withCredentials"],r=0,a=s.length;a>r;r++)n=s[r],i="type"===n?"responseType":n,n in b&&(D[i]=b[n]);u=b.headers;for(e in u)"Master-Cookie"!==e&&"Slave-Cookie"!==e&&(t=u[e],D.setRequestHeader(e,t));b.body instanceof h&&(b.body=b.body.fd),D.send(b.body)},t=L.listeners(r),(a=function(){var e,n;return t.length?(e=function(e){return"object"!=typeof e||"number"!=typeof e.status&&"number"!=typeof C.status?void a():(w(e,C),R.call(e,"data")<0&&(e.data=e.response||e.text),void T(4))},e.head=function(e){return w(e,C),T(2)},e.progress=function(e){return w(e,C),T(3)},n=t.shift(),1===n.length?e(n(b)):2===n.length&&b.async?n(b,e):e()):s()})()},f.abort=function(){M=e,A?D.abort():f[a]("abort",{})},f.setRequestHeader=function(e,t){var n,r;n=null!=e?e.toLowerCase():void 0,r=b.headerNames[n]=b.headerNames[n]||e,b.headers[r]&&(t=b.headers[r]+", "+t),b.headers[r]=t},f.getResponseHeader=function(e){var t;return t=null!=e?e.toLowerCase():void 0,C.headers[t]},f.getAllResponseHeaders=function(){return g(C.headers)},D.overrideMimeType&&(f.overrideMimeType=function(){return D.overrideMimeType.apply(D,arguments)}),D.upload&&(f.upload=b.upload=i()),f},L}"function"==typeof this.define&&this.define.amd?define("xhook",[],n):(this.exports||this).xhook=n()}).call(this,e),"function"==typeof this.define&&this.define.amd?define(["xhook"],function(e){return n(e)}):(e.xdomain=n(xhook),(this.exports||this).xdomain=e.xdomain)}).call(this,window);
